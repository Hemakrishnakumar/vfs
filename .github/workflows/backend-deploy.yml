name: vfs-server CI/CD

on:
  push:
    branches:
      - main
      - feature/**
      - fix/**
  pull_request:
    branches:
      - main

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: server

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run build (if exists)
        run: |
          if npm run | grep -q "build"; then
            npm run build
          else
            echo "No build script found, skipping..."
          fi

  deploy:
    name: Deploy to EC2
    env:
      APP_PATH: '${{ secrets.EC2_APP_PATH }}'
      REPO: '${{ github.repository }}'
  run: >
    ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "APP_PATH='$APP_PATH'
    REPO='$REPO' bash -s" << 'EOF'
      set -e

      echo "Deploying to $APP_PATH"

      mkdir -p "$APP_PATH"
      cd "$APP_PATH"

      if [ -d ".git" ]; then
        git pull origin main
      else
        git clone https://github.com/$REPO .
      fi

      cd server

      npm ci --omit=dev

      pm2 delete vfs-server || true
      pm2 start app.js --name vfs-server

      pm2 save
    EOF
